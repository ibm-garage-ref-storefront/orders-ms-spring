# Deploy the Orders Application on Open Liberty

You can run your Spring Boot applications on Open Liberty. Open Liberty will be the packaged server and the application will run on it instead of the default embedded server. Below are steps to run the Orders application on Open Liberty.

## Table of Contents

+ [Deploy the MySQL Docker Container](#deploy-the-ordersdb-docker-container)
+ [Deploy Orders locally](#deploy-orders-locally)
+ [Deploy the Orders Docker Container](#deploy-the-orders-docker-container)

## Deploy the MySQL Docker Container

Run MYSQL as a Docker container with the command below:

```
# Start a MySQL Container with a database user, a password, and create a new database
docker run --name ordersmysql \
    -e MYSQL_ROOT_PASSWORD=admin123 \
    -e MYSQL_USER=dbuser \
    -e MYSQL_PASSWORD=password \
    -e MYSQL_DATABASE=ordersdb \
    -p 3306:3306 \
    -d mysql:5.7.14
```

## Deploy Orders locally

In this section you will build and run the Spring Boot application on Open Liberty locally using Maven. Before we show you how to do so, you will need to deploy a MySQL Docker container as shown in [Deploy the MySQL Docker Container](#deploy-the-mysql-docker-container).

1. As the APIs in this microservice are OAuth protected, the HS256 shared secret used to sign the JWT generated by the [Authorization Server](https://github.com/ibm-cloud-architecture/refarch-cloudnative-auth) is needed to validate the access token provided by the caller.

To make things easier for you, we pasted below the 2048-bit secret that's included in the Orders Helm chart here, which you can export to your environment as follows:

```
$ export HS256_KEY="E6526VJkKYhyTFRFMC0pTECpHcZ7TGcq8pKsVVgz9KtESVpheEO284qKzfzg8HpWNBPeHOxNGlyudUHi6i8tFQJXC8PiI48RUpMh23vPDLGD35pCM0417gf58z5xlmRNii56fwRCmIhhV7hDsm3KO2jRv4EBVz7HrYbzFeqI45CaStkMYNipzSm2duuer7zRdMjEKIdqsby0JfpQpykHmC5L6hxkX0BT7XWqztTr6xHCwqst26O0g8r7bXSYjp4a"
```

However, if you must create your own 2048-bit secret, one can be generated using the following command:

```
$ cat /dev/urandom | env LC_CTYPE=C tr -dc 'a-zA-Z0-9' | fold -w 256 | head -n 1 | xargs echo -n
```

Note that if the [Authorization Server](https://github.com/ibm-cloud-architecture/refarch-cloudnative-auth) is deployed, it must use the same HS256 shared secret. 


2. Build the application as follows.

```
$ mvn clean install
```

3. Run the application on localhost.

```
java -Deureka.client.fetchRegistry=false \
        -Deureka.client.registerWithEureka=false \
        -Dspring.datasource.url=jdbc:mysql://127.0.0.1:3306/ordersdb \
        -Dspring.datasource.username=dbuser \
        -Dspring.datasource.password=password \
        -Dspring.datasource.port=3306 \
        -Djwt.sharedSecret=${HS256_KEY} \
        -jar target/micro-orders-0.0.1.jar
```

Once it is deployed, you will see something like below.

```
Orders microservice is ready for business...
[AUDIT   ] CWWKZ0001I: Application thin-micro-orders-0.0.1 started in 13.866 seconds.
[AUDIT   ] CWWKF0012I: The server installed the following features: [servlet-4.0, springBoot-1.5].
[AUDIT   ] CWWKF0011I: The server BoostServer is ready to run a smarter planet.
```

That's it, you have successfully deployed the Orders microservice. To validate the service, have a look at [Validate the Orders Microservice API](/README.md#validate-the-orders-microservice-api)

## Deploy the Orders Docker Container

In this section you will run the Spring Boot application on Open Liberty using Docker. Before we show you how to do so, you will need to deploy the MySQL Docker Container as shown in [Deploy the MySQL Docker Container](#deploy-the-mysql-docker-container).

Once it is deployed, we can run the Spring Boot Orders application on Open Liberty docker as follows:

1. Modify your POM file to generate the Docker image. Follow the below steps.
- Open [`pom.xml`](pom.xml)
- Modify the `boost-maven-plugin` as below.

```
            <plugin>
                <groupId>io.openliberty.boost</groupId>
                <artifactId>boost-maven-plugin</artifactId>
                <version>0.1</version>
                <executions>
                  <execution>
                    <!-- <phase>package</phase>
                    <goals>
                        <goal>package</goal>
                    </goals> -->
                    <goals>
                      <goal>docker-build</goal>
                    </goals>
                  </execution>
                </executions>
            </plugin>
```

2. As the APIs in this microservice are OAuth protected, the HS256 shared secret used to sign the JWT generated by the [Authorization Server](https://github.com/ibm-cloud-architecture/refarch-cloudnative-auth) is needed to validate the access token provided by the caller.

To make things easier for you, we pasted below the 2048-bit secret that's included in the Orders Helm chart here, which you can export to your environment as follows:

```
$ export HS256_KEY="E6526VJkKYhyTFRFMC0pTECpHcZ7TGcq8pKsVVgz9KtESVpheEO284qKzfzg8HpWNBPeHOxNGlyudUHi6i8tFQJXC8PiI48RUpMh23vPDLGD35pCM0417gf58z5xlmRNii56fwRCmIhhV7hDsm3KO2jRv4EBVz7HrYbzFeqI45CaStkMYNipzSm2duuer7zRdMjEKIdqsby0JfpQpykHmC5L6hxkX0BT7XWqztTr6xHCwqst26O0g8r7bXSYjp4a"
```

However, if you must create your own 2048-bit secret, one can be generated using the following command:

```
$ cat /dev/urandom | env LC_CTYPE=C tr -dc 'a-zA-Z0-9' | fold -w 256 | head -n 1 | xargs echo -n
```

Note that if the [Authorization Server](https://github.com/ibm-cloud-architecture/refarch-cloudnative-auth) is deployed, it must use the same HS256 shared secret. 

3. To deploy the Orders container, run the following commands:

Before building the Docker image, make sure there are no other dockerfiles in your repo. If a dockerfile already exists, please remove it.

```bash
# Build the Docker Image
$ mvn clean install 
```

Once done, a Docker image named `liberty-orders-spring:latest` will be built automatically for you.

Run the Docker container as follows.

```
# Start the Orders Container
$ docker run --name orders \
    -e MYSQL_HOST=${MYSQL_IP_ADDRESS} \
    -e MYSQL_PORT=3306 \
    -e MYSQL_USER=dbuser \
    -e MYSQL_PASSWORD=password \
    -e MYSQL_DATABASE=ordersdb \
    -e HS256_KEY=${HS256_KEY} \
    -p 8084:8084 \
    -d orders
```

That's it, you have successfully deployed the Orders microservice on Docker. To validate the service, have a look at [Validate the Orders Microservice API](/README.md#validate-the-orders-microservice-api)
